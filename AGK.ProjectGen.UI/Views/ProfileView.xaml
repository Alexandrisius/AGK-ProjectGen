<UserControl x:Class="AGK.ProjectGen.UI.Views.ProfileView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             mc:Ignorable="d" 
             d:DesignHeight="700" d:DesignWidth="1000">
    
    <Grid>
        <Grid.ColumnDefinitions>
            <ColumnDefinition Width="340"/>
            <ColumnDefinition Width="*"/>
        </Grid.ColumnDefinitions>
        
        <!-- ================================ -->
        <!--        ðŸ“‘ Ð¡ÐŸÐ˜Ð¡ÐžÐš ÐŸÐ ÐžÐ¤Ð˜Ð›Ð•Ð™        -->
        <!-- ================================ -->
        <Border Grid.Column="0" Style="{StaticResource CardStyle}" Margin="0,0,16,0">
            <DockPanel>
                <!-- Header -->
                <StackPanel DockPanel.Dock="Top" Margin="0,0,0,16">
                    <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                        <TextBlock Text="âš™ï¸" FontSize="20" Margin="0,0,8,0"/>
                        <TextBlock Text="ÐŸÑ€Ð¾Ñ„Ð¸Ð»Ð¸" Style="{StaticResource H2Style}"/>
                    </StackPanel>
                    <Button Content="âž•  ÐÐ¾Ð²Ñ‹Ð¹ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ" 
                            Style="{StaticResource PrimaryButtonStyle}" 
                            Command="{Binding CreateProfileCommand}"
                            HorizontalAlignment="Stretch"/>
                </StackPanel>
                
                <!-- Action Buttons for Selected Profile -->
                <Border DockPanel.Dock="Bottom" 
                        Margin="0,12,0,0" 
                        Visibility="{Binding SelectedProfile, Converter={StaticResource NullToVisibilityConverter}}">
                    <StackPanel>
                    <StackPanel Margin="0,0,0,8">
                        <Button Content="ðŸ“‹ ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ" 
                                Style="{StaticResource SecondaryButtonStyle}" 
                                Command="{Binding CopyProfileCommand}"
                                ToolTip="Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÐºÐ¾Ð¿Ð¸ÑŽ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ"
                                Padding="12,8"
                                Margin="0,0,0,6"/>
                        <Button Content="ðŸ—‘ï¸ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ" 
                                Style="{StaticResource SecondaryButtonStyle}" 
                                Command="{Binding DeleteProfileCommand}"
                                ToolTip="Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ"
                                Padding="12,8"/>
                    </StackPanel>
                        <Button Command="{Binding SetDefaultProfileCommand}"
                                Style="{StaticResource SecondaryButtonStyle}" 
                                HorizontalAlignment="Stretch"
                                Padding="10,6">
                            <Button.Content>
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock x:Name="StarIcon" Text="â­" Margin="0,0,6,0"/>
                                    <TextBlock Text="ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ"/>
                                </StackPanel>
                            </Button.Content>
                            <Button.ToolTip>
                                <TextBlock Text="Ð¡Ð´ÐµÐ»Ð°Ñ‚ÑŒ ÑÑ‚Ð¾Ñ‚ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÐµÐ¼ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ (Ð¸Ð»Ð¸ ÑÐ½ÑÑ‚ÑŒ Ð¾Ñ‚Ð¼ÐµÑ‚ÐºÑƒ)"/>
                            </Button.ToolTip>
                        </Button>
                    </StackPanel>
                </Border>
                
                <!-- Profile List -->
                <ListView ItemsSource="{Binding Profiles}" 
                          SelectedItem="{Binding SelectedProfile}"
                          Background="Transparent"
                          BorderThickness="0">
                    <ListView.ItemContainerStyle>
                        <Style TargetType="ListViewItem">
                            <Setter Property="Padding" Value="12,10"/>
                            <Setter Property="Margin" Value="0,2"/>
                            <Setter Property="Template">
                                <Setter.Value>
                                    <ControlTemplate TargetType="ListViewItem">
                                        <Border x:Name="Bd" 
                                                Background="{TemplateBinding Background}" 
                                                CornerRadius="6"
                                                Padding="{TemplateBinding Padding}">
                                            <ContentPresenter/>
                                        </Border>
                                        <ControlTemplate.Triggers>
                                            <Trigger Property="IsMouseOver" Value="True">
                                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource BgSecondaryBrush}"/>
                                            </Trigger>
                                            <Trigger Property="IsSelected" Value="True">
                                                <Setter TargetName="Bd" Property="Background" Value="{StaticResource BgTertiaryBrush}"/>
                                            </Trigger>
                                        </ControlTemplate.Triggers>
                                    </ControlTemplate>
                                </Setter.Value>
                            </Setter>
                        </Style>
                    </ListView.ItemContainerStyle>
                    <ListView.ItemTemplate>
                        <DataTemplate>
                            <Grid>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBlock Grid.Column="0" Text="ðŸ“‹" FontSize="14" Margin="0,0,10,0" Opacity="0.7"/>
                                <TextBlock Grid.Column="1" Text="{Binding Name}" FontSize="14" VerticalAlignment="Center"/>
                                <TextBlock Grid.Column="2" Text="â­" FontSize="12" Opacity="0.8" 
                                           VerticalAlignment="Center" Margin="8,0,0,0"
                                           ToolTip="ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ">
                                    <TextBlock.Style>
                                        <Style TargetType="TextBlock">
                                            <Setter Property="Visibility" Value="Collapsed"/>
                                            <Style.Triggers>
                                                <DataTrigger Value="True">
                                                    <DataTrigger.Binding>
                                                        <MultiBinding Converter="{StaticResource EqualityConverter}">
                                                            <Binding Path="Id"/>
                                                            <Binding Path="DataContext.DefaultProfileId" RelativeSource="{RelativeSource AncestorType=ListView}"/>
                                                        </MultiBinding>
                                                    </DataTrigger.Binding>
                                                    <Setter Property="Visibility" Value="Visible"/>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </TextBlock.Style>
                                </TextBlock>
                            </Grid>
                        </DataTemplate>
                    </ListView.ItemTemplate>
                </ListView>
            </DockPanel>
        </Border>
        
        <!-- ================================ -->
        <!--         âœï¸ Ð Ð•Ð”ÐÐšÐ¢ÐžÐ               -->
        <!-- ================================ -->
        <Border Grid.Column="1" Style="{StaticResource CardStyle}">
            <Grid>
                <!-- Editor (ÐºÐ¾Ð³Ð´Ð° Ð²Ñ‹Ð±Ñ€Ð°Ð½ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ) -->
                <DockPanel Visibility="{Binding SelectedProfile, Converter={StaticResource NullToVisibilityConverter}, FallbackValue=Collapsed}">
                    
                    <!-- Header -->
                    <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,20">
                        <TextBlock Text="âœï¸" FontSize="24" Margin="0,0,12,0"/>
                        <StackPanel>
                            <TextBlock Text="Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ" Style="{StaticResource H2Style}"/>
                            <TextBlock Text="ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° ÑÐ»Ð¾Ð²Ð°Ñ€ÐµÐ¹, Ñ‚Ð¸Ð¿Ð¾Ð² ÑƒÐ·Ð»Ð¾Ð² Ð¸ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹" 
                                       Style="{StaticResource LabelStyle}" Margin="0,2,0,0"/>
                        </StackPanel>
                    </StackPanel>
                    
                    <!-- Save Button -->
                    <Border DockPanel.Dock="Bottom" Margin="0,16,0,0">
                        <Button Content="{Binding SaveButtonText}" 
                                Command="{Binding SaveProfileCommand}" 
                                HorizontalAlignment="Left">
                            <Button.Style>
                                <Style TargetType="Button" BasedOn="{StaticResource PrimaryButtonStyle}">
                                    <Style.Triggers>
                                        <DataTrigger Binding="{Binding IsSaveSuccess}" Value="True">
                                            <Setter Property="Background" Value="{StaticResource AccentBrush}"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Button.Style>
                        </Button>
                    </Border>
                    
                    <!-- Tabs -->
                    <TabControl Background="Transparent" BorderThickness="0">
                        <TabControl.ItemContainerStyle>
                            <Style TargetType="TabItem">
                                <Setter Property="Padding" Value="16,10"/>
                                <Setter Property="FontWeight" Value="Medium"/>
                            </Style>
                        </TabControl.ItemContainerStyle>
                        
                        <!-- ========== TAB: ÐžÐ±Ñ‰Ð¸Ðµ ========== -->
                        <TabItem Header="ðŸ“ ÐžÐ±Ñ‰Ð¸Ðµ">
                            <ScrollViewer VerticalScrollBarVisibility="Auto" Margin="0,16,0,0">
                                <StackPanel HorizontalAlignment="Left" MinWidth="400">
                                    <TextBlock Text="ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ" Style="{StaticResource LabelStyle}" Margin="0,0,0,6"/>
                                    <TextBox Text="{Binding SelectedProfile.Name, UpdateSourceTrigger=PropertyChanged}"
                                             Style="{StaticResource ModernTextBoxStyle}"
                                             Margin="0,0,0,16"/>
                                    
                                    <TextBlock Text="Ð’ÐµÑ€ÑÐ¸Ñ" Style="{StaticResource LabelStyle}" Margin="0,0,0,6"/>
                                    <TextBox Text="{Binding SelectedProfile.Version, UpdateSourceTrigger=PropertyChanged}"
                                             Style="{StaticResource ModernTextBoxStyle}"/>
                                </StackPanel>
                            </ScrollViewer>
                        </TabItem>
                        
                        <!-- ========== TAB: ÐÑ‚Ñ€Ð¸Ð±ÑƒÑ‚Ñ‹ ========== -->
                        <TabItem Header="ðŸ“‹ ÐÑ‚Ñ€Ð¸Ð±ÑƒÑ‚Ñ‹">
                            <Grid Margin="0,16,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="320"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð¾Ð² -->
                                <DockPanel Grid.Column="0" Margin="0,0,12,0">
                                    <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,12">
                                        <Button Content="âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚" 
                                                Style="{StaticResource SecondaryButtonStyle}"
                                                Command="{Binding AddAttributeCommand}" 
                                                Padding="12,8"/>
                                        <Button Content="ðŸ—‘ï¸ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ" 
                                                Style="{StaticResource SecondaryButtonStyle}"
                                                Command="{Binding RemoveAttributeCommand}" 
                                                Padding="12,8" Margin="8,0,0,0"/>
                                    </StackPanel>
                                    
                                    <DataGrid ItemsSource="{Binding SelectedProfile.ProjectAttributes}" 
                                              SelectedItem="{Binding SelectedAttribute}"
                                              Style="{StaticResource ModernDataGridStyle}">
                                        <DataGrid.Columns>
                                            <DataGridTextColumn Header="ÐšÐ»ÑŽÑ‡" Binding="{Binding Key}" Width="150"/>
                                            <DataGridTextColumn Header="ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ" Binding="{Binding DisplayName}" Width="*"/>
                                            <DataGridTextColumn Header="Ð¢Ð¸Ð¿" Binding="{Binding Type}" Width="140"/>
                                            <DataGridCheckBoxColumn Header="ÐžÐ±ÑÐ·." Binding="{Binding IsRequired}" Width="80"/>
                                        </DataGrid.Columns>
                                    </DataGrid>
                                </DockPanel>
                                
                                <!-- ÐŸÐ°Ð½ÐµÐ»ÑŒ ÑÐ²Ð¾Ð¹ÑÑ‚Ð² Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð° -->
                                <Border Grid.Column="1" 
                                        Background="{StaticResource BgSecondaryBrush}"
                                        CornerRadius="8" Padding="16"
                                        Visibility="{Binding SelectedAttribute, Converter={StaticResource NullToVisibilityConverter}}">
                                    <StackPanel>
                                        <TextBlock Text="Ð¡Ð²Ð¾Ð¹ÑÑ‚Ð²Ð° Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð°" Style="{StaticResource H3Style}" Margin="0,0,0,16"/>
                                        
                                        <TextBlock Text="ÐšÐ»ÑŽÑ‡ (ID)" Style="{StaticResource LabelStyle}" Margin="0,0,0,6"/>
                                        <TextBox Text="{Binding SelectedAttribute.Key, UpdateSourceTrigger=PropertyChanged}" 
                                                 Style="{StaticResource ModernTextBoxStyle}" Margin="0,0,0,12"/>
                                        
                                        <TextBlock Text="ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ" Style="{StaticResource LabelStyle}" Margin="0,0,0,6"/>
                                        <TextBox Text="{Binding SelectedAttribute.DisplayName, UpdateSourceTrigger=PropertyChanged}" 
                                                 Style="{StaticResource ModernTextBoxStyle}" Margin="0,0,0,12"/>
                                        
                                        <TextBlock Text="Ð¢Ð¸Ð¿ Ð´Ð°Ð½Ð½Ñ‹Ñ…" Style="{StaticResource LabelStyle}" Margin="0,0,0,6"/>
                                        <ComboBox SelectedValue="{Binding SelectedAttribute.Type, Converter={StaticResource EnumToStringConverter}}"
                                                  SelectedValuePath="Tag"
                                                  Style="{StaticResource ModernComboBoxStyle}"
                                                  Margin="0,0,0,12">
                                            <ComboBoxItem Content="Ð¡Ñ‚Ñ€Ð¾ÐºÐ°" Tag="String"/>
                                            <ComboBoxItem Content="Ð§Ð¸ÑÐ»Ð¾" Tag="Integer"/>
                                            <ComboBoxItem Content="Ð”Ð°/ÐÐµÑ‚" Tag="Boolean"/>
                                            <ComboBoxItem Content="Ð”Ð°Ñ‚Ð°" Tag="Date"/>
                                            <ComboBoxItem Content="Ð¡Ð¿Ð¸ÑÐ¾Ðº (Ð²Ñ‹Ð±Ð¾Ñ€)" Tag="Select"/>
                                            <ComboBoxItem Content="ÐœÐ½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€" Tag="MultiSelect"/>
                                            <ComboBoxItem Content="Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð°" Tag="Table"/>
                                        </ComboBox>
                                        
                                        <TextBlock Text="Ð¡Ð»Ð¾Ð²Ð°Ñ€ÑŒ (Ð´Ð»Ñ ÑÐ¿Ð¸ÑÐºÐ¾Ð²)" Style="{StaticResource LabelStyle}" Margin="0,0,0,6"/>
                                        <ComboBox ItemsSource="{Binding SelectedProfile.Dictionaries}"
                                                  DisplayMemberPath="DisplayName"
                                                  SelectedValuePath="Key"
                                                  SelectedValue="{Binding SelectedAttribute.DictionaryKey}"
                                                  Style="{StaticResource ModernComboBoxStyle}"
                                                  Margin="0,0,0,12"/>
                                        
                                        <CheckBox Content="ÐžÐ±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾Ðµ Ð¿Ð¾Ð»Ðµ" 
                                                  IsChecked="{Binding SelectedAttribute.IsRequired}" 
                                                  Margin="0,0,0,8"/>
                                        <CheckBox Content="ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸" 
                                                  IsChecked="{Binding SelectedAttribute.IsProjectAttribute}" 
                                                  ToolTip="ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"
                                                  Margin="0,0,0,8"/>
                                        <CheckBox Content="Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ñ„Ð¾Ñ€Ð¼ÑƒÐ»Ð°Ñ…" 
                                                  IsChecked="{Binding SelectedAttribute.CanUseInFormula}" 
                                                  ToolTip="Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð² Ñ„Ð¾Ñ€Ð¼ÑƒÐ»Ð°Ñ… Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ñ"
                                                  Margin="0,0,0,12"/>
                                        
                                        <TextBlock Text="Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ" Style="{StaticResource LabelStyle}" Margin="0,0,0,6"/>
                                        <TextBox Text="{Binding SelectedAttribute.DefaultValue, UpdateSourceTrigger=PropertyChanged}" 
                                                 Style="{StaticResource ModernTextBoxStyle}" Margin="0,0,0,12"/>
                                        
                                        <TextBlock Text="ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ / Ð¿Ð¾Ð´ÑÐºÐ°Ð·ÐºÐ°" Style="{StaticResource LabelStyle}" Margin="0,0,0,6"/>
                                        <TextBox Text="{Binding SelectedAttribute.Description, UpdateSourceTrigger=PropertyChanged}" 
                                                 Style="{StaticResource ModernTextBoxStyle}" TextWrapping="Wrap" 
                                                 AcceptsReturn="True" MinHeight="60"/>
                                    </StackPanel>
                                </Border>
                                
                                <!-- Placeholder -->
                                <TextBlock Grid.Column="1" 
                                           Text="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚ Ð´Ð»Ñ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ"
                                           Style="{StaticResource LabelStyle}"
                                           HorizontalAlignment="Center" VerticalAlignment="Center"
                                           Visibility="{Binding SelectedAttribute, Converter={StaticResource InverseNullToVisibilityConverter}}"/>
                            </Grid>
                        </TabItem>
                        
                        <!-- ========== TAB: Ð¡Ð»Ð¾Ð²Ð°Ñ€Ð¸ ========== -->
                        <TabItem Header="ðŸ“š Ð¡Ð»Ð¾Ð²Ð°Ñ€Ð¸">
                            <Grid Margin="0,16,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="340"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>
                                
                                <!-- Ð¡Ð¿Ð¸ÑÐ¾Ðº ÑÐ»Ð¾Ð²Ð°Ñ€ÐµÐ¹ -->
                                <Border Grid.Column="0" Background="{StaticResource BgSecondaryBrush}" 
                                        CornerRadius="8" Padding="8" Margin="0,0,12,0">
                                    <DockPanel>
                                        <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,8">
                                            <Button Content="âž•" Padding="8,4" Margin="0,0,4,0"
                                                    Command="{Binding AddDictionaryCommand}"
                                                    Style="{StaticResource SecondaryButtonStyle}" ToolTip="Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÑÐ»Ð¾Ð²Ð°Ñ€ÑŒ"/>
                                            <Button Content="ðŸ—‘ï¸" Padding="8,4"
                                                    Command="{Binding RemoveDictionaryCommand}"
                                                    Style="{StaticResource SecondaryButtonStyle}" ToolTip="Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÐ»Ð¾Ð²Ð°Ñ€ÑŒ"/>
                                        </StackPanel>
                                        <ListBox ItemsSource="{Binding SelectedProfile.Dictionaries}"
                                                 SelectedItem="{Binding SelectedDictionary}"
                                                 Background="Transparent" BorderThickness="0">
                                            <ListBox.ItemTemplate>
                                                <DataTemplate>
                                                    <TextBlock Text="{Binding DisplayName}" Margin="4" FontSize="14"/>
                                                </DataTemplate>
                                            </ListBox.ItemTemplate>
                                        </ListBox>
                                    </DockPanel>
                                </Border>
                                
                                <!-- Ð ÐµÐ´Ð°ÐºÑ‚Ð¾Ñ€ ÑÐ»Ð¾Ð²Ð°Ñ€Ñ -->
                                <Border Grid.Column="1" Background="{StaticResource BgSecondaryBrush}" 
                                        CornerRadius="8" Padding="16"
                                        Visibility="{Binding SelectedDictionary, Converter={StaticResource NullToVisibilityConverter}}">
                                    <DockPanel>
                                        <!-- Ð¡Ð²Ð¾Ð¹ÑÑ‚Ð²Ð° ÑÐ»Ð¾Ð²Ð°Ñ€Ñ -->
                                        <StackPanel DockPanel.Dock="Top" Margin="0,0,0,16">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="*"/>
                                                </Grid.ColumnDefinitions>
                                                <StackPanel Grid.Column="0" Margin="0,0,8,0">
                                                    <TextBlock Text="ÐšÐ»ÑŽÑ‡ (Key)" Style="{StaticResource LabelStyle}" Margin="0,0,0,4"/>
                                                    <TextBox Text="{Binding SelectedDictionary.Key, UpdateSourceTrigger=PropertyChanged}"
                                                             Style="{StaticResource ModernTextBoxStyle}"/>
                                                </StackPanel>
                                                <StackPanel Grid.Column="1" Margin="8,0,0,0">
                                                    <TextBlock Text="ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ" Style="{StaticResource LabelStyle}" Margin="0,0,0,4"/>
                                                    <TextBox Text="{Binding SelectedDictionary.DisplayName, UpdateSourceTrigger=PropertyChanged}"
                                                             Style="{StaticResource ModernTextBoxStyle}"/>
                                                </StackPanel>
                                            </Grid>
                                            
                                            <CheckBox Content="Ð—Ð°Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°" 
                                                      IsChecked="{Binding SelectedDictionary.IsDynamic}" 
                                                      VerticalContentAlignment="Center"
                                                      Margin="0,12,0,0"
                                                      ToolTip="Ð•ÑÐ»Ð¸ Ð²ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ â€” ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹ Ð½Ðµ Ð·Ð°Ð´Ð°ÑŽÑ‚ÑÑ Ð² Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ðµ, Ð° Ð²Ð²Ð¾Ð´ÑÑ‚ÑÑ Ð¿Ñ€Ð¸ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ð¸ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ð°"/>
                                        </StackPanel>
                                        
                                        <!-- Ð­Ð»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹ ÑÐ»Ð¾Ð²Ð°Ñ€Ñ (ÑÐºÑ€Ñ‹Ñ‚ÑŒ Ð´Ð»Ñ Ð´Ð¸Ð½Ð°Ð¼Ð¸Ñ‡ÐµÑÐºÐ¸Ñ…) -->
                                        <DockPanel Visibility="{Binding SelectedDictionary.IsDynamic, Converter={StaticResource InverseBoolToVisibilityConverter}, FallbackValue=Visible}">
                                            <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,8">
                                                <TextBlock Text="Ð­Ð»ÐµÐ¼ÐµÐ½Ñ‚Ñ‹ ÑÐ»Ð¾Ð²Ð°Ñ€Ñ" Style="{StaticResource H3Style}" Margin="0,0,16,0"/>
                                                <Button Content="âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ" Padding="10,6"
                                                        Command="{Binding AddDictionaryItemCommand}"
                                                        Style="{StaticResource SecondaryButtonStyle}"/>
                                                <Button Content="ðŸ—‘ï¸ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ" Padding="10,6" Margin="8,0,0,0"
                                                        Command="{Binding RemoveDictionaryItemCommand}"
                                                        Style="{StaticResource SecondaryButtonStyle}"/>
                                            </StackPanel>
                                            
                                            <DataGrid ItemsSource="{Binding SelectedDictionary.Items}"
                                                      SelectedItem="{Binding SelectedDictionaryItem}"
                                                      Style="{StaticResource ModernDataGridStyle}"
                                                      IsReadOnly="False"
                                                      RowHeight="40"
                                                      HorizontalAlignment="Left"
                                                      MaxWidth="800">
                                                <DataGrid.Columns>
                                                    <DataGridTextColumn Header="ÐšÐ¾Ð´" Binding="{Binding Code}" Width="150"/>
                                                    <DataGridTextColumn Header="ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ" Binding="{Binding Name}" Width="*"/>
                                                </DataGrid.Columns>
                                            </DataGrid>
                                        </DockPanel>
                                    </DockPanel>
                                </Border>
                                
                                <!-- Placeholder -->
                                <TextBlock Grid.Column="1" 
                                           Text="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ»Ð¾Ð²Ð°Ñ€ÑŒ Ð´Ð»Ñ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ"
                                           Style="{StaticResource LabelStyle}"
                                           HorizontalAlignment="Center" VerticalAlignment="Center"
                                           Visibility="{Binding SelectedDictionary, Converter={StaticResource InverseNullToVisibilityConverter}}"/>
                            </Grid>
                        </TabItem>
                        
                        <!-- ========== TAB: Ð¢Ð¸Ð¿Ñ‹ ÑƒÐ·Ð»Ð¾Ð² ========== -->
                        <TabItem Header="ðŸ“¦ Ð¢Ð¸Ð¿Ñ‹ ÑƒÐ·Ð»Ð¾Ð²">
                            <DockPanel Margin="0,16,0,0">
                                <StackPanel DockPanel.Dock="Top" Orientation="Horizontal" Margin="0,0,0,12">
                                    <Button Content="âž• Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚Ð¸Ð¿" 
                                            Style="{StaticResource SecondaryButtonStyle}"
                                            Command="{Binding AddNodeTypeCommand}" 
                                            Padding="12,8"/>
                                    <Button Content="ðŸ—‘ï¸ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ" 
                                            Style="{StaticResource SecondaryButtonStyle}"
                                            Command="{Binding RemoveNodeTypeCommand}" 
                                            Padding="12,8" Margin="8,0,0,0"/>
                                </StackPanel>
                                
                                <DataGrid ItemsSource="{Binding SelectedProfile.NodeTypes}" 
                                          Style="{StaticResource ModernDataGridStyle}"
                                          IsReadOnly="False"
                                          RowHeight="44">
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Header="ID" Binding="{Binding TypeId}" Width="*" IsReadOnly="True"/>
                                        <DataGridTextColumn Header="ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ" Binding="{Binding DisplayName}" Width="*"/>
                                        <DataGridTextColumn Header="Ð¤Ð¾Ñ€Ð¼ÑƒÐ»Ð° Ð¸Ð¼ÐµÐ½Ð¸" Binding="{Binding DefaultFormula}" Width="2*"/>
                                    </DataGrid.Columns>
                                </DataGrid>
                            </DockPanel>
                        </TabItem>
                        
                        <!-- ========== TAB: Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° ========== -->
                        <TabItem Header="ðŸŒ³ Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°">
                            <Grid Margin="0,16,0,0">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="*"/>
                                </Grid.RowDefinitions>
                                
                                <!-- Actions -->
                                <StackPanel Grid.Row="0" Orientation="Horizontal" Margin="0,0,0,12">
                                    <Button Content="âž• ÐšÐ¾Ñ€ÐµÐ½ÑŒ" 
                                            Style="{StaticResource SecondaryButtonStyle}"
                                            Command="{Binding AddRootNodeCommand}" 
                                            Margin="0,0,8,0" Padding="12,8"/>
                                    <Button Content="âž• Ð”Ð¾Ñ‡ÐµÑ€Ð½Ð¸Ð¹" 
                                            Style="{StaticResource SecondaryButtonStyle}"
                                            Command="{Binding AddChildNodeCommand}" 
                                            Margin="0,0,8,0" Padding="12,8"/>
                                    <Button Content="ðŸ—‘ï¸ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ" 
                                            Style="{StaticResource SecondaryButtonStyle}"
                                            Command="{Binding RemoveNodeCommand}" 
                                            Padding="12,8"/>
                                </StackPanel>
                                
                                <Grid Grid.Row="1">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="300"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <!-- Tree -->
                                    <Border Grid.Column="0" 
                                            Background="{StaticResource BgSecondaryBrush}"
                                            CornerRadius="8" Padding="8"
                                            BorderBrush="{StaticResource BorderBrush}" BorderThickness="1">
                                        <TreeView ItemsSource="{Binding SelectedProfile.Structure.RootNodes}" 
                                                  SelectedItemChanged="OnStructureNodeSelected"
                                                  Background="Transparent" BorderThickness="0">
                                            <TreeView.ItemTemplate>
                                                <HierarchicalDataTemplate ItemsSource="{Binding Children}">
                                                    <StackPanel Orientation="Horizontal" Margin="4"
                                                                MouseLeftButtonDown="OnStructureNodeClicked">
                                                        <TextBlock Margin="0,0,8,0" FontSize="14">
                                                            <TextBlock.Style>
                                                                <Style TargetType="TextBlock">
                                                                    <Setter Property="Text" Value="ðŸ“‚"/>
                                                                    <Style.Triggers>
                                                                        <DataTrigger Binding="{Binding IsRoot}" Value="True">
                                                                            <Setter Property="Text" Value="ðŸ "/>
                                                                        </DataTrigger>
                                                                    </Style.Triggers>
                                                                </Style>
                                                            </TextBlock.Style>
                                                        </TextBlock>
                                                        <TextBlock Text="{Binding NodeTypeId}" FontWeight="Bold"/>
                                                        <TextBlock Text=" â†’ " Foreground="{StaticResource TextSecondaryBrush}"/>
                                                        <TextBlock Text="{Binding SourceKey}" Foreground="{StaticResource PrimaryBrush}"/>
                                                    </StackPanel>
                                                </HierarchicalDataTemplate>
                                            </TreeView.ItemTemplate>
                                        </TreeView>
                                    </Border>
                                    
                                    <!-- Properties Panel -->
                                    <Border Grid.Column="1" Margin="12,0,0,0"
                                            Visibility="{Binding SelectedStructureNode, Converter={StaticResource NullToVisibilityConverter}}">
                                        <StackPanel>
                                            <TextBlock Text="Ð¡Ð²Ð¾Ð¹ÑÑ‚Ð²Ð° ÑƒÐ·Ð»Ð°" Style="{StaticResource H3Style}" Margin="0,0,0,16"/>
                                            
                                            <TextBlock Text="Ð¢Ð¸Ð¿ ÑƒÐ·Ð»Ð°" Style="{StaticResource LabelStyle}" Margin="0,0,0,6"/>
                                            <ComboBox ItemsSource="{Binding SelectedProfile.NodeTypes}" 
                                                      DisplayMemberPath="DisplayName" 
                                                      SelectedValuePath="TypeId" 
                                                      SelectedValue="{Binding SelectedStructureNode.NodeTypeId}"
                                                      Style="{StaticResource ModernComboBoxStyle}"
                                                      Margin="0,0,0,16"/>
                                                      
                                            <TextBlock Text="ÐšÑ€Ð°Ñ‚Ð½Ð¾ÑÑ‚ÑŒ" Style="{StaticResource LabelStyle}" Margin="0,0,0,6"/>
                                            <ComboBox SelectedValue="{Binding SelectedStructureNode.Multiplicity, Converter={StaticResource EnumToStringConverter}}"
                                                      SelectedValuePath="Tag"
                                                      Style="{StaticResource ModernComboBoxStyle}"
                                                      Margin="0,0,0,16"
                                                      IsEnabled="{Binding SelectedStructureNode.IsRoot, Converter={StaticResource InverseBoolConverter}}"
                                                      ToolTip="Single â€” Ð¾Ð´Ð½Ð° Ð¿Ð°Ð¿ÐºÐ°. Dictionary â€” Ð¿Ð¾ ÑÐ»Ð¾Ð²Ð°Ñ€ÑŽ. (Ð”Ð»Ñ ÐºÐ¾Ñ€Ð½ÐµÐ²Ð¾Ð³Ð¾ ÑƒÐ·Ð»Ð° â€” Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Single)">
                                                <ComboBoxItem Content="Single (Ð¾Ð´Ð½Ð° Ð¿Ð°Ð¿ÐºÐ°)" Tag="Single"/>
                                                <ComboBoxItem Content="Dictionary (Ð¿Ð¾ ÑÐ»Ð¾Ð²Ð°Ñ€ÑŽ)" Tag="Dictionary"/>
                                            </ComboBox>
                                            
                                            <!-- Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº (ÑÐ»Ð¾Ð²Ð°Ñ€ÑŒ) â€” Ð´Ð»Ñ Single Ð¸ Dictionary, ÐµÑÐ»Ð¸ ÐÐ• ÐºÐ¾Ñ€ÐµÐ½ÑŒ -->
                                            <StackPanel Visibility="{Binding SelectedStructureNode.IsRoot, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                                <TextBlock Text="Ð˜ÑÑ‚Ð¾Ñ‡Ð½Ð¸Ðº (ÑÐ»Ð¾Ð²Ð°Ñ€ÑŒ)" Style="{StaticResource LabelStyle}" Margin="0,0,0,6"/>
                                                <ComboBox ItemsSource="{Binding SelectedProfile.Dictionaries}"
                                                          DisplayMemberPath="DisplayName"
                                                          SelectedValuePath="Key"
                                                          SelectedValue="{Binding SelectedStructureNode.SourceKey}"
                                                          Style="{StaticResource ModernComboBoxStyle}"
                                                          Margin="0,0,0,16"
                                                          ToolTip="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ»Ð¾Ð²Ð°Ñ€ÑŒ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¸ Ð¿Ð°Ð¿ÐºÐ¸"
                                                          SelectionChanged="OnSourceKeyChanged"/>
                                            </StackPanel>
                                            
                                            <!-- Ð’Ñ‹Ð±Ð¾Ñ€ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð° ÑÐ»Ð¾Ð²Ð°Ñ€Ñ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Single Ñ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¼ ÑÐ»Ð¾Ð²Ð°Ñ€Ñ‘Ð¼) -->
                                            <StackPanel>
                                                <StackPanel.Style>
                                                    <Style TargetType="StackPanel">
                                                        <Setter Property="Visibility" Value="Collapsed"/>
                                                        <Style.Triggers>
                                                            <MultiDataTrigger>
                                                                <MultiDataTrigger.Conditions>
                                                                    <Condition Binding="{Binding SelectedStructureNode.Multiplicity}" Value="Single"/>
                                                                    <Condition Binding="{Binding SelectedStructureNode.SourceKey, Converter={StaticResource NullToBoolConverter}}" Value="False"/>
                                                                </MultiDataTrigger.Conditions>
                                                                <Setter Property="Visibility" Value="Visible"/>
                                                            </MultiDataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </StackPanel.Style>
                                                <TextBlock Text="Ð­Ð»ÐµÐ¼ÐµÐ½Ñ‚ ÑÐ»Ð¾Ð²Ð°Ñ€Ñ" Style="{StaticResource LabelStyle}" Margin="0,0,0,6"/>
                                                <ComboBox ItemsSource="{Binding SelectedDictionaryItems}"
                                                          DisplayMemberPath="Name"
                                                          SelectedValuePath="Code"
                                                          SelectedValue="{Binding SelectedStructureNode.SelectedItemCode, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                                          Style="{StaticResource ModernComboBoxStyle}"
                                                          Margin="0,0,0,16"
                                                          ToolTip="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚ Ð´Ð»Ñ Ð¿Ñ€Ð¸ÑÐ²Ð¾ÐµÐ½Ð¸Ñ ÑÑ‚Ð¾Ð¹ Ð¿Ð°Ð¿ÐºÐµ (Ð´Ð»Ñ Ñ„Ð¾Ñ€Ð¼ÑƒÐ»)"/>
                                            </StackPanel>
                                            
                                            <TextBlock Text="Ð¤Ð¾Ñ€Ð¼ÑƒÐ»Ð° Ð¸Ð¼ÐµÐ½Ð¸ (override)" Style="{StaticResource LabelStyle}" Margin="0,0,0,6"/>
                                            <TextBox Text="{Binding SelectedStructureNode.NamingFormulaOverride}" 
                                                     Style="{StaticResource ModernTextBoxStyle}" Margin="0,0,0,24"/>
                                            
                                            <!-- ACL Button -->
                                            <Button Content="ðŸ” ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ ACL" 
                                                    Style="{StaticResource SecondaryButtonStyle}"
                                                    Command="{Binding ConfigureAclCommand}" 
                                                    Padding="12,10"
                                                    ToolTip="ÐÐ°ÑÑ‚Ñ€Ð¾Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ð´Ð»Ñ Ð´Ð°Ð½Ð½Ð¾Ð³Ð¾ ÑƒÐ·Ð»Ð° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹"/>
                                        </StackPanel>
                                    </Border>
                                </Grid>
                            </Grid>
                        </TabItem>
                    </TabControl>
                </DockPanel>
            
                <!-- Placeholder (ÐºÐ¾Ð³Ð´Ð° Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½) -->
                <StackPanel Visibility="{Binding SelectedProfile, Converter={StaticResource InverseNullToVisibilityConverter}, FallbackValue=Visible}"
                            HorizontalAlignment="Center" VerticalAlignment="Center">
                    <TextBlock Text="ðŸ“‹" FontSize="64" HorizontalAlignment="Center" Opacity="0.3"/>
                    <TextBlock Text="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ" 
                               Style="{StaticResource H3Style}" 
                               Foreground="{StaticResource TextSecondaryBrush}"
                               HorizontalAlignment="Center" Margin="0,16,0,8"/>
                    <TextBlock Text="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ ÑÐ»ÐµÐ²Ð° Ð´Ð»Ñ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑÐ»Ð¾Ð²Ð°Ñ€ÐµÐ¹ Ð¸ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹" 
                               Style="{StaticResource LabelStyle}"
                               HorizontalAlignment="Center"/>
                </StackPanel>
            </Grid>
        </Border>
    </Grid>
</UserControl>
