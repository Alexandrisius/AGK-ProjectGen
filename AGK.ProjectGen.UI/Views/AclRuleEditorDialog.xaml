<Window x:Class="AGK.ProjectGen.UI.Views.AclRuleEditorDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:enums="clr-namespace:AGK.ProjectGen.Domain.Enums;assembly=AGK.ProjectGen.Domain"
        Title="ðŸ” Ð ÐµÐ´Ð°ÐºÑ‚Ð¾Ñ€ Ð¿Ñ€Ð°Ð²Ð¸Ð» ACL" Height="800" Width="1100"
        WindowStartupLocation="CenterOwner"
        Background="{StaticResource BgPrimaryBrush}">
    
    <Window.Resources>
        <ObjectDataProvider x:Key="ConditionOperators" MethodName="GetValues" ObjectType="{x:Type enums:ConditionOperator}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="enums:ConditionOperator"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>
        <ObjectDataProvider x:Key="AccessRights" MethodName="GetValues" ObjectType="{x:Type enums:ProjectAccessRights}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="enums:ProjectAccessRights"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>
    </Window.Resources>
    
    <Grid Margin="16">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>
        
        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,16">
            <TextBlock Text="ÐÐ°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ° Ð¿Ñ€Ð°Ð²Ð¸Ð» Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°" Style="{StaticResource H2Style}"/>
            <TextBlock Text="{Binding NodeTypeInfo}" Style="{StaticResource LabelStyle}" Margin="0,4,0,0"/>
        </StackPanel>
        
        <!-- Main Content -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="300"/>
                <ColumnDefinition Width="*"/>
            </Grid.ColumnDefinitions>
            
            <!-- Rules List -->
            <Border Grid.Column="0" Background="{StaticResource BgSecondaryBrush}" CornerRadius="8" Padding="12" Margin="0,0,8,0">
                <DockPanel>
                    <StackPanel DockPanel.Dock="Top" Margin="0,0,0,12">
                        <!-- Toolbar Ñ ÐºÐ½Ð¾Ð¿ÐºÐ°Ð¼Ð¸ -->
                        <WrapPanel Orientation="Horizontal">
                            <!-- ÐŸÑ€Ð°Ð²Ð¸Ð»Ð° -->
                            <Button Content="âž•" Padding="6,4" Style="{StaticResource SecondaryButtonStyle}" 
                                    Command="{Binding AddRuleCommand}" ToolTip="Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð¾"/>
                            <Button Content="ðŸ—‘ï¸" Padding="6,4" Margin="2,0,0,0" Style="{StaticResource SecondaryButtonStyle}" 
                                    Command="{Binding RemoveRuleCommand}" ToolTip="Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð¾"/>
                            
                            <!-- Ð Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚ÐµÐ»ÑŒ -->
                            <Rectangle Width="1" Fill="{StaticResource BorderBrush}" Margin="8,4"/>
                            
                            <!-- ÐŸÑ€ÐµÑÐµÑ‚Ñ‹ -->
                            <Button Content="ðŸ“¥" Padding="6,4" 
                                    Style="{StaticResource SecondaryButtonStyle}" 
                                    Command="{Binding LoadPresetCommand}" 
                                    ToolTip="Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð¿Ñ€ÐµÑÐµÑ‚ ACL"/>
                            <Button Content="ðŸ’¾" Padding="6,4" Margin="2,0,0,0" 
                                    Style="{StaticResource SecondaryButtonStyle}" 
                                    Command="{Binding SaveAsPresetCommand}" 
                                    ToolTip="Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ ÐºÐ°Ðº Ð¿Ñ€ÐµÑÐµÑ‚"/>
                            <Button Content="âš™ï¸" Padding="6,4" Margin="2,0,0,0" 
                                    Style="{StaticResource SecondaryButtonStyle}" 
                                    Command="{Binding ManagePresetsCommand}" 
                                    ToolTip="Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ñ€ÐµÑÐµÑ‚Ð°Ð¼Ð¸"/>
                            
                            <!-- Ð Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚ÐµÐ»ÑŒ -->
                            <Rectangle Width="1" Fill="{StaticResource BorderBrush}" Margin="8,4"/>
                            
                            <!-- Ð“Ñ€ÑƒÐ¿Ð¿Ñ‹ -->
                            <Button Content="ðŸ‘¥" Padding="6,4" 
                                    Style="{StaticResource SecondaryButtonStyle}" 
                                    Command="{Binding ManageGroupsCommand}" 
                                    ToolTip="Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ¿Ð¿Ð°Ð¼Ð¸"/>
                        </WrapPanel>
                    </StackPanel>
                    
                    <ListBox ItemsSource="{Binding Rules}" 
                             SelectedItem="{Binding SelectedRule}"
                             Style="{StaticResource ModernListBoxStyle}">
                        <ListBox.ItemTemplate>
                            <DataTemplate>
                                <StackPanel Margin="4">
                                    <TextBlock Text="{Binding PrincipalIdentity}" FontWeight="SemiBold"
                                               TextTrimming="CharacterEllipsis"/>
                                    <TextBlock Text="{Binding Rights}" FontSize="11" Opacity="0.7"/>
                                </StackPanel>
                            </DataTemplate>
                        </ListBox.ItemTemplate>
                    </ListBox>
                </DockPanel>
            </Border>
            
            <!-- Rule Editor -->
            <Border Grid.Column="1" Background="{StaticResource BgSecondaryBrush}" CornerRadius="8" Padding="16" Margin="8,0,0,0"
                    Visibility="{Binding SelectedRule, Converter={StaticResource NullToVisibilityConverter}}">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel>
                        <!-- Principal Selection -->
                        <TextBlock Text="Ð¡ÑƒÐ±ÑŠÐµÐºÑ‚ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾ÑÑ‚Ð¸" Style="{StaticResource H3Style}" Margin="0,0,0,8"/>
                        
                        <!-- Smart Search -->
                        <TextBlock Text="ðŸ” ÐŸÐ¾Ð¸ÑÐº (Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‡Ð°ÑÑ‚ÑŒ Ð¸Ð¼ÐµÐ½Ð¸ Ð¸Ð»Ð¸ Ð»Ð¾Ð³Ð¸Ð½Ð°):" Style="{StaticResource LabelStyle}" Margin="0,0,0,4"/>
                        <Grid>
                            <Grid.RowDefinitions>
                                <RowDefinition Height="Auto"/>
                                <RowDefinition Height="Auto"/>
                            </Grid.RowDefinitions>
                            
                            <TextBox Grid.Row="0"
                                     Text="{Binding PrincipalSearchQuery, UpdateSourceTrigger=PropertyChanged}"
                                     Style="{StaticResource ModernTextBoxStyle}"
                                     Padding="8,8"
                                     ToolTip="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ñ‡Ð°ÑÑ‚ÑŒ Ð¸Ð¼ÐµÐ½Ð¸, Ð»Ð¾Ð³Ð¸Ð½Ð° Ð¸Ð»Ð¸ Ñ„Ð°Ð¼Ð¸Ð»Ð¸Ð¸ Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ°"/>
                            
                            <!-- Search Results Dropdown -->
                            <Popup Grid.Row="1" 
                                   IsOpen="{Binding IsSearchDropdownOpen}"
                                   PlacementTarget="{Binding ElementName=PrincipalSearchBox}"
                                   Placement="Bottom"
                                   StaysOpen="False"
                                   AllowsTransparency="True">
                                <Border Background="White" 
                                        BorderBrush="{StaticResource BorderBrush}" 
                                        BorderThickness="1" 
                                        CornerRadius="4"
                                        MaxHeight="200"
                                        MinWidth="350">
                                    <ListBox ItemsSource="{Binding FilteredPrincipals}"
                                             BorderThickness="0"
                                             Background="Transparent"
                                             MaxHeight="200">
                                        <ListBox.ItemTemplate>
                                            <DataTemplate>
                                                <Border Padding="8,6" Cursor="Hand">
                                                    <Border.InputBindings>
                                                        <MouseBinding MouseAction="LeftClick" 
                                                                      Command="{Binding DataContext.SelectPrincipalFromSearchCommand, RelativeSource={RelativeSource AncestorType=Window}}"
                                                                      CommandParameter="{Binding}"/>
                                                    </Border.InputBindings>
                                                    <StackPanel>
                                                        <TextBlock Text="{Binding FullName}" FontWeight="SemiBold"/>
                                                        <TextBlock Text="{Binding Description}" 
                                                                   Style="{StaticResource LabelStyle}" 
                                                                   FontSize="11"
                                                                   TextTrimming="CharacterEllipsis"/>
                                                    </StackPanel>
                                                </Border>
                                            </DataTemplate>
                                        </ListBox.ItemTemplate>
                                    </ListBox>
                                </Border>
                            </Popup>
                            
                            <!-- Selected Principal Info -->
                            <Border Grid.Row="1" 
                                    Visibility="{Binding SelectedPrincipal, Converter={StaticResource NullToVisibilityConverter}}"
                                    Background="{StaticResource BgPrimaryBrush}" 
                                    CornerRadius="4" 
                                    Padding="8" 
                                    Margin="0,4,0,0">
                                <StackPanel Orientation="Horizontal">
                                    <TextBlock Text="âœ…" Margin="0,0,6,0"/>
                                    <TextBlock Text="{Binding SelectedPrincipal.FullName}" FontWeight="SemiBold"/>
                                    <TextBlock Text="{Binding SelectedPrincipal.Description, StringFormat=' â€” {0}'}" 
                                               Style="{StaticResource LabelStyle}" Margin="4,0,0,0"/>
                                </StackPanel>
                            </Border>
                        </Grid>
                        
                        <!-- Manual Entry (backup option) -->
                        <Expander Header="Ð˜Ð»Ð¸ Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ" Margin="0,8,0,0" IsExpanded="False">
                            <Grid Margin="0,8,0,0">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="Auto"/>
                                </Grid.ColumnDefinitions>
                                <TextBox Text="{Binding CustomPrincipalName, UpdateSourceTrigger=PropertyChanged}" 
                                         Style="{StaticResource ModernTextBoxStyle}" 
                                         ToolTip="Ð¤Ð¾Ñ€Ð¼Ð°Ñ‚: DOMAIN\UserName Ð¸Ð»Ð¸ Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¸Ð¼Ñ"/>
                                <Button Grid.Column="1" Content="ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ" Padding="12,6" Margin="8,0,0,0"
                                        Style="{StaticResource SecondaryButtonStyle}" 
                                        Command="{Binding ApplyCustomPrincipalCommand}"/>
                            </Grid>
                        </Expander>
                        
                        <!-- Rights -->
                        <TextBlock Text="ÐŸÑ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°" Style="{StaticResource H3Style}" Margin="0,16,0,8"/>
                        <ComboBox ItemsSource="{Binding Source={StaticResource AccessRights}}"
                                  SelectedItem="{Binding SelectedRule.Rights}"
                                  Style="{StaticResource ModernComboBoxStyle}" Margin="0,0,0,8"/>
                        
                        <CheckBox Content="Ð—Ð°Ð¿Ñ€ÐµÑ‚Ð¸Ñ‚ÑŒ (Deny)" IsChecked="{Binding SelectedRule.IsDeny}" Margin="0,0,0,16"/>
                        
                        <!-- Conditions -->
                        <TextBlock Text="Ð£ÑÐ»Ð¾Ð²Ð¸Ñ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ" Style="{StaticResource H3Style}" Margin="0,0,0,8"/>
                        <TextBlock Text="ÐŸÑ€Ð°Ð²Ð¸Ð»Ð¾ Ð¿Ñ€Ð¸Ð¼ÐµÐ½ÑÐµÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ð’Ð¡Ð• ÑƒÑÐ»Ð¾Ð²Ð¸Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÑÑŽÑ‚ÑÑ:" 
                                   Style="{StaticResource LabelStyle}" Margin="0,0,0,8" TextWrapping="Wrap"/>
                        
                        <StackPanel Orientation="Horizontal" Margin="0,0,0,8">
                            <Button Content="âž• Ð£ÑÐ»Ð¾Ð²Ð¸Ðµ" Padding="10,6" Style="{StaticResource SecondaryButtonStyle}" 
                                    Command="{Binding AddConditionCommand}"/>
                            <Button Content="ðŸ—‘ï¸ Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ" Padding="10,6" Margin="8,0,0,0" Style="{StaticResource SecondaryButtonStyle}" 
                                    Command="{Binding RemoveConditionCommand}"/>
                        </StackPanel>
                        
                        <DataGrid ItemsSource="{Binding CurrentConditions}"
                                  AutoGenerateColumns="False"
                                  CanUserAddRows="False"
                                  CanUserDeleteRows="False"
                                  CanUserReorderColumns="False"
                                  HeadersVisibility="Column"
                                  GridLinesVisibility="Horizontal"
                                  HorizontalGridLinesBrush="{StaticResource BorderBrush}"
                                  RowHeight="44"
                                  BorderThickness="1"
                                  BorderBrush="{StaticResource BorderBrush}"
                                  Background="White">
                            <DataGrid.Columns>
                                <!-- Ð§ÐµÐºÐ±Ð¾ÐºÑ Ð²Ñ‹Ð±Ð¾Ñ€Ð° -->
                                <DataGridTemplateColumn Width="32" CanUserResize="False">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <CheckBox IsChecked="{Binding IsSelected, UpdateSourceTrigger=PropertyChanged}"
                                                      HorizontalAlignment="Center" VerticalAlignment="Center"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                
                                <!-- ÐÑ‚Ñ€Ð¸Ð±ÑƒÑ‚ -->
                                <DataGridTemplateColumn Header="ÐÑ‚Ñ€Ð¸Ð±ÑƒÑ‚" Width="*" MinWidth="120">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <ComboBox Text="{Binding AttributePath, UpdateSourceTrigger=PropertyChanged}"
                                                      ItemsSource="{Binding DataContext.CommonAttributes, RelativeSource={RelativeSource AncestorType=Window}}"
                                                      IsEditable="True"
                                                      Style="{StaticResource ModernComboBoxStyle}"
                                                      Margin="2"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                
                                <!-- ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ -->
                                <DataGridTemplateColumn Header="ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€" Width="100">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <ComboBox ItemsSource="{Binding Source={StaticResource ConditionOperators}}"
                                                      SelectedItem="{Binding Operator, UpdateSourceTrigger=PropertyChanged}"
                                                      Style="{StaticResource ModernComboBoxStyle}"
                                                      Margin="2"/>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                                
                                <!-- Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ -->
                                <DataGridTemplateColumn Header="Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ" Width="*" MinWidth="80">
                                    <DataGridTemplateColumn.CellTemplate>
                                        <DataTemplate>
                                            <Grid>
                                                <TextBox x:Name="ValueTextBox"
                                                         Text="{Binding Value, UpdateSourceTrigger=PropertyChanged}"
                                                         Style="{StaticResource ModernTextBoxStyle}"
                                                         Padding="6,4" Margin="2"
                                                         ToolTip="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ = Ð´Ð»Ñ Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ð°Ñ‚Ñ€Ð¸Ð±ÑƒÑ‚Ð°"/>
                                                <Popup IsOpen="{Binding IsValueDropdownOpen}"
                                                       PlacementTarget="{Binding ElementName=ValueTextBox}"
                                                       Placement="Bottom"
                                                       StaysOpen="False"
                                                       AllowsTransparency="True">
                                                    <Border Background="White" 
                                                            BorderBrush="{StaticResource BorderBrush}" 
                                                            BorderThickness="1" 
                                                            CornerRadius="4"
                                                            MaxHeight="150"
                                                            MinWidth="200">
                                                        <ListBox ItemsSource="{Binding FilteredValueSuggestions}"
                                                                 BorderThickness="0"
                                                                 Background="Transparent"
                                                                 MaxHeight="150"
                                                                 SelectionMode="Single">
                                                            <ListBox.ItemContainerStyle>
                                                                <Style TargetType="ListBoxItem">
                                                                    <Setter Property="Padding" Value="0"/>
                                                                    <Setter Property="Margin" Value="0"/>
                                                                </Style>
                                                            </ListBox.ItemContainerStyle>
                                                            <ListBox.ItemTemplate>
                                                                <DataTemplate>
                                                                    <Border Padding="8,6" Cursor="Hand" Background="Transparent">
                                                                        <Border.InputBindings>
                                                                            <MouseBinding MouseAction="LeftClick" 
                                                                                          Command="{Binding DataContext.SelectValueSuggestionCommand, RelativeSource={RelativeSource AncestorType=Grid}}"
                                                                                          CommandParameter="{Binding}"/>
                                                                        </Border.InputBindings>
                                                                        <TextBlock Text="{Binding}" FontFamily="Consolas"/>
                                                                    </Border>
                                                                </DataTemplate>
                                                            </ListBox.ItemTemplate>
                                                        </ListBox>
                                                    </Border>
                                                </Popup>
                                            </Grid>
                                        </DataTemplate>
                                    </DataGridTemplateColumn.CellTemplate>
                                </DataGridTemplateColumn>
                            </DataGrid.Columns>
                        </DataGrid>
                        
                        <!-- Description -->
                        <TextBlock Text="ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð°" Style="{StaticResource LabelStyle}" Margin="0,8,0,4"/>
                        <TextBox Text="{Binding SelectedRule.Description, UpdateSourceTrigger=PropertyChanged}" 
                                 Style="{StaticResource ModernTextBoxStyle}"/>
                    </StackPanel>
                </ScrollViewer>
            </Border>
            
            <!-- Placeholder -->
            <TextBlock Grid.Column="1" 
                       Text="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¸Ð»Ð¸ Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¿Ñ€Ð°Ð²Ð¸Ð»Ð¾"
                       Style="{StaticResource LabelStyle}"
                       HorizontalAlignment="Center" VerticalAlignment="Center"
                       Visibility="{Binding SelectedRule, Converter={StaticResource InverseNullToVisibilityConverter}}"/>
        </Grid>
        
        <!-- Footer -->
        <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right" Margin="0,16,0,0">
            <Button Content="ÐžÑ‚Ð¼ÐµÐ½Ð°" Padding="20,10" Style="{StaticResource SecondaryButtonStyle}" 
                    IsCancel="True" Click="Cancel_Click"/>
            <Button Content="ðŸ’¾ Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ" Padding="20,10" Margin="12,0,0,0" 
                    Style="{StaticResource PrimaryButtonStyle}" Click="Save_Click"/>
        </StackPanel>
    </Grid>
</Window>
